# 🗺️ LLM 기반 전략 생성 시스템 개발 로드맵 (Final)

## 📋 목차
1. [프로젝트 개요 및 핵심 원칙](#프로젝트-개요-및-핵심-원칙)
2. [아키텍처 및 데이터 흐름](#아키텍처-및-데이터-흐름)
3. [기술 스택 및 의존성](#기술-스택-및-의존성)
4. [단계별 상세 개발 계획](#단계별-상세-개발-계획)
5. [개발 가이드라인](#개발-가이드라인)
6. [마일스톤 및 일정](#마일스톤-및-일정)

---

## 프로젝트 개요 및 핵심 원칙

### 목표
- 자연어 입력으로 트레이딩 전략 코드를 자동 생성
- Azure OpenAI (Entra ID 인증) 활용
- 생성된 전략을 백테스트/라이브 트레이딩에서 활용
- **기존 라이브 트레이딩 시스템에 영향 없음**

### 핵심 원칙

#### 1. 격리 (Isolation)
- **LLM 관련 모든 로직은 `src/llm/` 내부에 구현**
- 기존 코어 로직(`src/live/`, `src/backtest/`)과 분리
- 신규 전략 파일 자동 인식은 최소 변경으로 처리 (지양)

#### 2. 안정성 (Stability)
- 생성된 전략은 **"런타임 스모크 테스트"**를 통과하기 전까지는 절대 저장되거나 실행 목록에 노출되지 않음
- 3단계 검증: Static → Structure → Runtime

#### 3. 표준화 (Standardization)
- 지표 계산은 **pandas-ta 라이브러리 사용** (직접 수식 구현 금지)
- 일관된 지표 인터페이스 제공

#### 4. 테스트 데이터 독립성
- 테스트 코드 작성 시 **절대 외부 API(Binance)를 호출하지 않음**
- 모든 검증은 `data/sample_btc_1m.csv`를 사용
- 동적 Resampling으로 다양한 타임프레임 지원

---

## 아키텍처 및 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                    Local PC (LLMTrader)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Streamlit UI (pages/2_🤖_전략생성.py)                     │  │
│  │  - 자연어 입력                                            │  │
│  │  - 코드 미리보기 & 수정                                   │  │
│  │  - [검증] 버튼 → 스모크 테스트                            │  │
│  │  - [저장] 버튼 (검증 통과 시만 활성화)                    │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                          │
│  ┌────────────────────▼─────────────────────────────────────┐  │
│  │ src/llm/ (격리된 LLM 모듈)                                │  │
│  │  ├── client.py          # 중계서버 HTTP 클라이언트        │  │
│  │  ├── pipeline.py        # 3단계 파이프라인                │  │
│  │  ├── intent_parser.py   # Stage 1: 의도 분석              │  │
│  │  ├── spec_generator.py  # Stage 2: 명세 생성              │  │
│  │  ├── code_generator.py # Stage 3: 코드 생성              │  │
│  │  ├── validator.py       # 3단계 검증 + 런타임 스모크      │  │
│  │  ├── prompts.py         # 프롬프트 템플릿                 │  │
│  │  ├── templates.py       # 전략 코드 템플릿                 │  │
│  │  └── utils.py           # 데이터 로더 & Resampling         │  │
│  └────────────────────┬─────────────────────────────────────┘  │
│                       │                                          │
│  ┌────────────────────▼─────────────────────────────────────┐  │
│  │ src/indicators/                                          │  │
│  │  ├── registry.py        # pandas-ta 기반 지표 레지스트리  │  │
│  │  ├── rsi.py             # 기존 (유지)                    │  │
│  │  └── pandas_ta_wrapper.py # pandas-ta 래퍼 (신규)        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 검증 데이터: data/sample_btc_1m.csv                      │  │
│  │  - 최소 2주 분량 (약 20,000 row)                         │  │
│  │  - 동적 Resampling (1m → 15m, 4h 등)                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                  │
│  생성된 전략 파일 (*_strategy.py)                               │
│  └──▶ 기존 시스템 자동 인식 (수정 불필요)                       │
│                                                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │ HTTP
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│              중계 서버 (192.168.219.122:8000)                    │
├─────────────────────────────────────────────────────────────────┤
│  FastAPI 서버                                                    │
│  POST /generate-strategy → Azure OpenAI (Entra ID)              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 기술 스택 및 의존성

### 기존 스택
- Python 3.11+
- Streamlit (UI)
- FastAPI (중계 서버)
- Azure OpenAI (GPT-4o)

### 신규 추가 의존성

```toml
# pyproject.toml에 추가
dependencies = [
    # 기존...
    "httpx>=0.27.0",        # 비동기 HTTP (이미 있음)
    "pandas-ta>=0.3.14b0",  # 지표 계산 라이브러리 (신규)
    "pandas>=2.0.0",        # 데이터 처리 & Resampling (신규)
]
```

---

## 단계별 상세 개발 계획

### Phase 0: 사전 준비 (Prerequisites) - 3일

#### 목표
개발 및 검증을 위한 환경 세팅

#### 작업 내용

**0-1. 의존성 추가 (1일)**
- [ ] `pyproject.toml`에 `pandas-ta`, `pandas` 추가
- [ ] `uv sync` 실행하여 의존성 설치 확인
- [ ] 버전 호환성 테스트

**0-2. 검증 데이터 준비 (1일)**
- [ ] `data/` 디렉토리 생성
- [ ] `data/sample_btc_1m.csv` 준비
  - 최소 2주 분량 (약 20,000 row)
  - 컬럼: `timestamp`, `open`, `high`, `low`, `close`, `volume`
  - 형식: CSV (UTC 타임스탬프)
- [ ] 데이터 검증 스크립트 작성

**0-3. 중계 서버 API 확인 (1일)**
- [ ] 중계 서버 연결 테스트
- [ ] API 엔드포인트 스펙 문서화
- [ ] Entra ID 인증 테스트 (중계 서버에서)

#### 산출물
- 의존성 설치 완료
- 검증 데이터 준비 완료
- API 스펙 문서

---

### Phase 1: 기반 인프라 구축 (Infrastructure) - 2주

#### 1-1. 지표 시스템 확장 (pandas-ta 기반) - 4일

**목표**: pandas-ta를 활용한 지표 레지스트리 구축

**작업 내용**:
- [ ] `src/indicators/pandas_ta_wrapper.py` 생성
  - [ ] pandas-ta 래퍼 클래스 구현
  - [ ] 주요 지표 함수 래핑 (RSI, MACD, BB, ATR, Stochastic, OBV 등)
  - [ ] Context 인터페이스와 호환되는 형태로 반환값 변환
- [ ] `src/indicators/registry.py` 생성
  - [ ] `IndicatorSpec` 데이터 클래스
  - [ ] pandas-ta 기반 지표 자동 등록
  - [ ] LLM에게 제공할 지표 설명 자동 추출 (Docstring 기반)
  - [ ] `get_llm_context()` 메서드 구현
- [ ] 기존 `src/indicators/rsi.py` 유지 (호환성)
- [ ] Context 통합
  - [ ] `BacktestContext.get_indicator()` 확장
  - [ ] `LiveContext.get_indicator()` 확장
  - [ ] pandas-ta 지표 호출 로직 추가

**산출물**:
- pandas-ta 래퍼 모듈
- 지표 레지스트리
- Context 통합 완료

#### 1-2. LLM 클라이언트 모듈 - 2일

**목표**: 중계 서버와의 통신 인터페이스

**작업 내용**:
- [ ] `src/llm/__init__.py` 생성
- [ ] `src/llm/client.py` 구현
  - [ ] `LLMClient` 클래스
  - [ ] `generate_strategy()` 메서드 (비동기)
  - [ ] `health_check()` 메서드
  - [ ] 타임아웃/에러 핸들링
  - [ ] 재시도 로직
- [ ] 테스트 스크립트 작성

**산출물**:
- LLM 클라이언트 모듈
- 연결 테스트 통과

#### 1-3. 데이터 유틸리티 (Resampling) - 2일

**목표**: 검증용 데이터 로더 및 Resampling

**작업 내용**:
- [ ] `src/llm/utils.py` 생성
  - [ ] `load_and_resample_data(filepath, target_interval)` 구현
  - [ ] `sample_btc_1m.csv` 로드
  - [ ] pandas를 사용한 동적 Resampling (1m → 15m, 4h 등)
  - [ ] 타임프레임 변환 유틸리티
- [ ] Resampling 테스트 작성

**산출물**:
- 데이터 로더 모듈
- Resampling 기능 검증

#### 1-4. 프롬프트 시스템 - 2일

**목표**: LLM에게 제공할 프롬프트 템플릿 구축

**작업 내용**:
- [ ] `src/llm/prompts.py` 생성
  - [ ] `StrategyContext` 인터페이스 정보 주입
  - [ ] Context API 명세 문자열 생성
  - [ ] 안전 규칙 문자열
  - [ ] 참조 코드 (rsi_long_short_strategy.py)
  - [ ] **중요**: "항상 pandas-ta를 사용하여 지표를 계산하라"는 지침 포함
- [ ] `src/llm/templates.py` 생성
  - [ ] 전략 코드 템플릿
  - [ ] 파라미터화된 템플릿

**산출물**:
- 프롬프트 템플릿 모듈
- 명세 문서

---

### Phase 2: 검증 시스템 (Validation System - Critical) - 1.5주

#### 2-1. 정적 검증 (Level 1) - 2일

**목표**: 문법 및 구조 검사

**작업 내용**:
- [ ] `src/llm/validator.py` 생성
- [ ] Level 1: Static 검증 구현
  - [ ] `ast.parse()`를 사용한 문법 체크
  - [ ] 금지된 import 검사 (`os`, `sys`, `subprocess`, `eval`, `exec` 등)
  - [ ] 파일 시스템 접근 차단
  - [ ] 네트워크 접근 차단
- [ ] 검증 테스트 작성

**산출물**:
- 정적 검증 모듈

#### 2-2. 구조 검증 (Level 2) - 2일

**목표**: 전략 클래스 구조 검증

**작업 내용**:
- [ ] Level 2: Structure 검증 구현
  - [ ] `Strategy` 클래스 상속 확인
  - [ ] 필수 메서드 존재 확인 (`initialize`, `on_bar`)
  - [ ] 메서드 시그니처 검증
- [ ] 검증 테스트 작성

**산출물**:
- 구조 검증 모듈

#### 2-3. 런타임 스모크 테스트 (Level 3) - 3일

**목표**: 실제 실행 가능 여부 검증

**작업 내용**:
- [ ] Level 3: Runtime Smoke Test 구현
  - [ ] 전략 클래스 동적 로드 (`importlib`)
  - [ ] Mock Context 생성
  - [ ] `sample_btc_1m.csv` 데이터 주입
  - [ ] 타겟 타임프레임으로 Resampling
  - [ ] 전략 인스턴스화
  - [ ] `initialize()` 호출
  - [ ] `on_bar()` 1회 실행 (에러 발생 여부 확인)
  - [ ] 예외 캡처 및 리포트 생성
- [ ] 다양한 에러 시나리오 테스트

**산출물**:
- 런타임 스모크 테스트 모듈
- 검증 리포트 시스템

---

### Phase 3: 생성 파이프라인 (Generation Pipeline) - 2주

#### 3-1. Intent Parser (Stage 1) - 3일

**목표**: 자연어 의도 분석 및 요소 추출

**작업 내용**:
- [ ] `src/llm/intent_parser.py` 구현
  - [ ] `IntentParser` 클래스
  - [ ] 의도 분류 (VALID_STRATEGY, INCOMPLETE, OFF_TOPIC, CLARIFICATION_NEEDED)
  - [ ] 지표 추출 (pandas-ta 지표명 매핑)
  - [ ] 타겟 심볼 추출 (기본값: BTCUSDT)
  - [ ] 타임프레임 추출 (1m, 15m, 4h 등)
  - [ ] 진입/청산 조건 추출
  - [ ] 리스크 관리 요소 추출
  - [ ] 누락 요소 감지
- [ ] 프롬프트 최적화
- [ ] 다양한 입력 테스트

**산출물**:
- Intent Parser 모듈
- 의도 분석 테스트 통과

#### 3-2. Spec Generator (Stage 2) - 3일

**목표**: 구조화된 전략 명세 생성

**작업 내용**:
- [ ] `src/llm/spec_generator.py` 구현
  - [ ] `StrategySpec` 데이터 클래스 정의
  - [ ] `SpecGenerator` 클래스
  - [ ] Intent 결과 → JSON 명세 변환
  - [ ] 지표 파라미터 매핑
  - [ ] 진입/청산 규칙 구조화
  - [ ] 리스크 관리 설정 구조화
- [ ] 명세 스키마 정의
- [ ] 테스트 케이스 작성

**산출물**:
- Spec Generator 모듈
- 명세 생성 테스트 통과

#### 3-3. Code Generator (Stage 3) - 3일

**목표**: Python 코드 생성

**작업 내용**:
- [ ] `src/llm/code_generator.py` 구현
  - [ ] `CodeGenerator` 클래스
  - [ ] 명세 → 코드 변환
  - [ ] 템플릿 기반 코드 생성
  - [ ] pandas-ta 지표 호출 코드 생성
  - [ ] 안전 패턴 강제 (중복 주문/청산 방지)
- [ ] 프롬프트 최적화
- [ ] 생성 코드 품질 테스트

**산출물**:
- Code Generator 모듈
- 실행 가능한 코드 생성 확인

#### 3-4. 파이프라인 통합 - 2일

**목표**: 3단계 파이프라인 통합

**작업 내용**:
- [ ] `src/llm/pipeline.py` 구현
  - [ ] `StrategyGenerationPipeline` 클래스
  - [ ] 3단계 순차 실행
  - [ ] 에러 핸들링 및 복구
  - [ ] 검증 파이프라인 자동 연결
- [ ] 통합 테스트 작성

**산출물**:
- 통합 파이프라인
- End-to-end 테스트 통과

---

### Phase 4: UI 통합 (User Interface) - 1.5주

#### 4-1. 기본 UI 구조 - 2일

**작업 내용**:
- [ ] `pages/2_🤖_전략생성.py` 생성
  - [ ] 페이지 레이아웃
  - [ ] 자연어 입력 영역 (`st.text_area`)
  - [ ] 생성 버튼
  - [ ] 상태 표시 (로딩, 성공, 실패)
- [ ] 메인 페이지(`streamlit_app.py`)에 링크 추가

**산출물**:
- 기본 UI 페이지

#### 4-2. 코드 미리보기 및 수정 기능 - 2일

**작업 내용**:
- [ ] 생성된 코드 표시
  - [ ] `st.text_area`로 코드 표시 (수정 가능)
  - [ ] Syntax highlighting (선택적)
  - [ ] 코드 복사 기능
- [ ] Human-in-the-loop 기능
  - [ ] 사용자가 코드 직접 수정 가능
  - [ ] 수정된 코드 재검증 옵션

**산출물**:
- 코드 미리보기 및 수정 UI

#### 4-3. 검증 및 저장 기능 - 2일

**작업 내용**:
- [ ] 검증 버튼 구현
  - [ ] 클릭 시 3단계 검증 실행
  - [ ] 검증 결과 표시 (에러/경고)
  - [ ] 런타임 스모크 테스트 진행 상황 표시
- [ ] 저장 기능 구현
  - [ ] 검증 통과 시에만 [저장] 버튼 활성화
  - [ ] 전략 이름 입력
  - [ ] 파일 저장 (`*_strategy.py`)
  - [ ] 저장 성공 메시지
- [ ] 생성된 전략 목록 표시

**산출물**:
- 검증 및 저장 기능 완료

#### 4-4. 대화형 보완 및 에러 처리 - 2일

**작업 내용**:
- [ ] 불완전한 입력 처리
  - [ ] 확인 질문 표시
  - [ ] 기본값 제안
  - [ ] 기본값으로 진행 옵션
- [ ] Off-topic 입력 처리
  - [ ] 안내 메시지
  - [ ] 예시 제안
- [ ] 에러 복구 UI
  - [ ] 검증 실패 시 상세 에러 표시
  - [ ] 수정 가이드 제공

**산출물**:
- 대화형 보완 UI

---

### Phase 5: 통합 및 최종 테스트 - 1주

#### 5-1. 기존 시스템 연동 확인 - 2일

**작업 내용**:
- [ ] 생성된 전략 자동 인식 확인
  - [ ] `pages/3_📊_백테스트.py`에서 생성 전략 표시 확인
  - [ ] `pages/4_🔴_라이브_트레이딩.py`에서 생성 전략 표시 확인
  - [ ] 기존 전략과 동일하게 동작 확인
- [ ] 통합 테스트

**산출물**:
- 기존 시스템 연동 확인 완료

#### 5-2. 종합 테스트 - 3일

**작업 내용**:
- [ ] 다양한 자연어 입력 테스트
  - [ ] 간단한 전략 (RSI 기반)
  - [ ] 복합 전략 (여러 지표 조합)
  - [ ] 모호한 입력
  - [ ] Off-topic 입력
- [ ] 생성된 전략 실행 테스트
  - [ ] 백테스트 실행
  - [ ] 라이브 트레이딩 스모크 테스트 (테스트넷)
- [ ] 성능 테스트
  - [ ] 응답 시간 측정
  - [ ] 동시 요청 처리
- [ ] 에지 케이스 테스트

**산출물**:
- 테스트 리포트
- 버그 수정 완료

---

## 개발 가이드라인

### 필수 규칙

#### 1. 기존 코드 불변
- **`src/live/` 및 `src/backtest/` 폴더 내의 코드는 절대 수정하지 않는다**
- 신규 전략 파일 자동 인식은 최소 변경으로 처리 (지양)

#### 2. 모듈화
- 모든 신규 로직은 `src/llm/` 패키지 내부에 위치
- 지표 관련은 `src/indicators/`에 pandas-ta 래퍼 추가

#### 3. 테스트 데이터 독립성
- 테스트 코드 작성 시 **절대 외부 API(Binance)를 호출하지 않는다**
- 모든 검증은 `data/sample_btc_1m.csv`를 사용
- Resampling으로 다양한 타임프레임 지원

#### 4. 안전한 저장
- `validator.py`의 Runtime Check를 통과하지 못한 코드는 **절대 파일 시스템에 저장하지 않는다**
- 검증 실패 시 저장/실행 목록에 노출 금지

#### 5. 지표 활용
- 복잡한 지표 수식을 직접 짜지 말고 **pandas-ta 라이브러리 활용을 최우선으로 한다**
- 기존 `rsi.py`는 호환성을 위해 유지

#### 6. 런타임 검증 필수
- 모든 생성 코드는 **런타임 스모크 테스트를 통과해야 함**
- Mock Context + 샘플 데이터로 실제 실행 검증

---

## 마일스톤 및 일정

| 마일스톤 | 기간 | 완료 기준 |
|---------|------|-----------|
| **M0: 사전 준비** | 3일 | 의존성 설치, 검증 데이터 준비, API 확인 |
| **M1: 인프라 구축** | 2주 | 지표 시스템(pandas-ta) + LLM 클라이언트 + 데이터 유틸 |
| **M2: 검증 시스템** | 1.5주 | 3단계 검증(Static/Structure/Runtime) 완료 |
| **M3: 생성 파이프라인** | 2주 | 3단계 파이프라인(Intent/Spec/Code) 통합 완료 |
| **M4: UI 통합** | 1.5주 | Streamlit UI에서 전략 생성 및 검증 가능 |
| **M5: 통합 및 테스트** | 1주 | 기존 시스템 연동 및 종합 테스트 완료 |

**총 예상 기간: 8주 (약 2개월)**

---

## 우선순위 및 위험 관리

### 최우선 (Critical Path)
1. **Phase 2: 검증 시스템** (런타임 스모크 테스트)
2. **Phase 3: 생성 파이프라인** (3단계)
3. **Phase 1-1: pandas-ta 기반 지표 시스템**

### 위험 요소 및 대응

| 위험 | 영향도 | 대응 방안 |
|------|--------|-----------|
| pandas-ta 호환성 문제 | 중간 | 버전 고정, 래퍼 레이어로 추상화 |
| 런타임 검증 실패율 높음 | 높음 | 프롬프트 최적화, Few-shot 예시 추가 |
| 중계 서버 연결 불안정 | 중간 | 재시도 로직, 폴백 메시지 |
| 생성 코드 품질 불안정 | 높음 | 템플릿 강제, 검증 강화 |

---

## 다음 단계

1. **Phase 0 시작**: 의존성 추가 및 검증 데이터 준비
2. **Phase 1-1 시작**: pandas-ta 기반 지표 시스템 구축
3. **개발 환경 설정**: 필요한 디렉토리 구조 생성

---

## 참고 자료

- 기존 개발 계획: `development_plan.md`
- Strategy 인터페이스: `src/strategy/base.py`, `src/strategy/context.py`
- 참조 전략 코드: `rsi_long_short_strategy.py`
- 중계 서버 API: `http://192.168.219.122:8000/docs`
